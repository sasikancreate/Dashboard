<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ติดตามผลแผนปฏิบัติราชการเชียงใหม่</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 600px; border-radius: 15px; }
        .info-box { transition: transform 0.3s; }
        .info-box:hover { transform: translateY(-5px); }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold text-center text-blue-900 mb-8">
            ต้นแบบ Dashboard ติดตามผลการดำเนินงานตามแผนปฏิบัติราชการประจำงบประมาณ พ.ศ. 2568
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="info-box bg-white p-6 rounded-xl shadow-md border-l-8 border-blue-500">
                <p class="text-gray-500 text-sm font-semibold uppercase">จำนวนโครงการทั้งหมด</p>
                <h2 class="text-4xl font-bold text-blue-900">14 <span class="text-lg">โครงการ</span></h2>
            </div>
            <div class="info-box bg-white p-6 rounded-xl shadow-md border-l-8 border-green-500">
                <p class="text-gray-500 text-sm font-semibold uppercase">งบประมาณรวม</p>
                <h2 class="text-4xl font-bold text-green-700">342,906,200 <span class="text-lg">บาท</span></h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">แผนที่แสดงผลรายอำเภอ (Heat Map)</h3>
                <div id="map"></div>
            </div>

            <div id="project-detail" class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-blue-800">รายละเอียดโครงการ</h3>
                <p class="text-gray-500 italic">กรุณาคลิกเลือกอำเภอในแผนที่เพื่อดูข้อมูล</p>
                <div id="detail-content" class="mt-4 space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        // โหลดข้อมูลจาก data.json ที่ส่งมาจาก Apps Script
        async function initDashboard() {
            const response = await fetch('districts.json');
            const data = await response.json();
            
            // ตั้งค่า Map (พิกัดกลางเชียงใหม่)
            const dName = feature.properties.amphoe_th || feature.properties.NAME_2 || feature.properties.dist_name;
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            // ตัวอย่างการวาด GeoJSON และใส่สี Heat Map
            // คุณต้องมีไฟล์ chiangmai-districts.json
            fetch('districts.json')
                .then(res => res.json())
                .then(geoData => {
                    L.geoJSON(geoData, {
                        style: function(feature) {
                            // คำนวณสีตามผลการดำเนินงานจาก data.projects
                            return { fillColor: '#3b82f6', weight: 2, opacity: 1, color: 'white', fillOpacity: 0.7 };
                        },
                        onEachFeature: function(feature, layer) {
                            layer.on('click', () => showDetails(feature.properties.dist_name, data.projects));
                        }
                    }).addTo(map);
                });
        }

        function showDetails(districtName, projects) {
            const content = document.getElementById('detail-content');
            const filtered = projects.filter(p => p.Districts.includes(districtName));
            
            if(filtered.length === 0) {
                content.innerHTML = `<p class="text-red-500">ไม่พบโครงการในพื้นที่ ${districtName}</p>`;
                return;
            }

            content.innerHTML = `<h4 class="font-bold text-lg text-gray-800 underline">${districtName}</h4>`;
            filtered.forEach(p => {
                content.innerHTML += `
                    <div class="p-3 border rounded-lg bg-blue-50">
                        <p class="font-semibold text-blue-900">${p.Project_Name}</p>
                        <p class="text-sm text-gray-600">สถานะ: ${p.Status}</p>
                        <p class="text-sm font-bold text-green-600">งบประมาณ: ${Number(p.Budget).toLocaleString()} บาท</p>
                    </div>
                `;
            });
        }

        initDashboard();
    </script>
</body>
</html>
// 1. ฟังก์ชันกำหนดสีตามความก้าวหน้า (Score-based Heat Map)
function getColor(districtName, projectsData) {
    // กรองเอาเฉพาะโครงการที่อยู่ในอำเภอนี้
    const districtProjects = projectsData.filter(p => p.Districts && p.Districts.includes(districtName));
    
    if (districtProjects.length === 0) return '#e5e7eb'; // สีเทาถ้าไม่มีโครงการ

    // ให้คะแนนตามสถานะ (ตัวอย่างการแบ่งกลุ่ม)
    let totalScore = 0;
    districtProjects.forEach(p => {
        if (p.Status.includes('ดำเนินการเสร็จสิ้น')) totalScore += 3;
        else if (p.Status.includes('อยู่ระหว่างดำเนินการ') || p.Status.includes('ลงนาม')) totalScore += 2;
        else totalScore += 1; // อยู่ระหว่างจัดซื้อจัดจ้าง หรือเริ่มต้น
    });

    const avgScore = totalScore / districtProjects.length;

    // คืนค่าสีตามคะแนนเฉลี่ย
    return avgScore >= 2.5 ? '#28A745' : // เขียวเข้ม (ก่อหนี้และนำเข้าระบบ GFMIS แล้ว)
           avgScore >= 1.5 ? '#85C88A' : // เขียวอ่อน (ลงนามแล้วอยู่ระหว่างนำเข้าระบบ)
                             '#A7D948' ; // เขียวมะนาว (อยู่ระหว่างประกาศผลผู้ชนะ/ลงนามแล้ว)
                             '#F4D03F' : // เหลืองเข้ม (อยู่ระหว่างอุทธรณ์ผลการจัดซื้อจัดจ้าง)
                             '#F39C12' : // ส้มเหลือง (อยู่ระหว่างประกาศเชิญชวน)
                             '#E67E22' : // ส้ม (อยู่ระหว่างดำเนินการ)
                             '#D35400' : // ส้มแดง (อยู่ระหว่างรอการอนุมัติรายงานขอซื้อขอจ้าง)
                             '#E74C3C' : // แดงชมพู (อยู่ระหว่างจัดทำร่างขอบเขตงาน (TOR))
                             '#C0392B' : // แดงเข้ม (อยู่ระหว่างอนุมัติโครงการ)
                             '#424242' : // เทา (ยกเลิกกิจกรรม)
}
